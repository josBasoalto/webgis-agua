<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Reportes</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        img {
            margin-top: 8px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script>
    // ================================
    //   INICIALIZAR MAPA
    // ================================
    var map = L.map('map').setView([-37.47, -72.32], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // ================================
    //   CARGAR CSV
    // ================================
    Papa.parse("data/reporte.csv", {
        download: true,
        header: true,
        complete: function(results) {
            console.log("CSV cargado:", results.data);
            agregarPuntos(results.data);
        }
    });

    // ================================
    //   AGREGAR PUNTOS AL MAPA
    // ================================
    function agregarPuntos(data) {

        data.forEach(row => {

            let lat = parseFloat(row["_Ubicación GPS del punto reportado_latitude"]);
            let lon = parseFloat(row["_Ubicación GPS del punto reportado_longitude"]);

            if (!isNaN(lat) && !isNaN(lon)) {

                let marker = L.marker([lat, lon]).addTo(map);

                // ─────────────── POPUP ───────────────
                let popupContent = `
                    <b>Origen del agua:</b> ${row["Origen del agua"] || "—"}<br>
                    <b>Nombre:</b> ${row["Nombre del río, canal, tranque o pozo"] || "—"}<br>
                    <b>Grado de afectación:</b> ${row["Grado de afectación"] || row["Grado de afectaciÃ³n"] || "—"}<br>
                    <b>Observaciones:</b> ${row["Observaciones adicionales"] || "—"}<br>
                `;

                // ─────────────── IMAGEN ───────────────
                if (row["Fotografía del punto (opcional)_URL"]) {
                    popupContent += `
                        <br><img src="${row["Fotografía del punto (opcional)_URL"]}" width="250">
                    `;
                }

                marker.bindPopup(popupContent);
            }
        });
    }

    </script>

</body>
</html>
