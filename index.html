<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>WebGIS ‚Äì Disponibilidad de Agua Agr√≠cola</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
    }

    #map {
        height: 100vh;
        width: 100%;
    }

    /* Panel lateral */
    #sidebar {
        position: absolute;
        top: 0px;
        right: 0px;
        width: 320px;
        background: rgb(114, 179, 196);
        padding: 18px;
        border-radius: 10px;
        box-shadow: 0px 0px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        max-height: 100vh;
        overflow-y: auto;
    }

    #sidebar h2 {
        background: #0078d4;
        color: white;
        padding: 6px;
        margin: 5px 0;
        border-radius: 4px;
        font-size:16px;
    }

    #sidebar h3 {
        font-size: 15px;
        margin-top: 20px;
        border-bottom:2px solid white;
        padding-bottom: 4px;
    }

    p {
        font-size: 14px;
        margin-bottom: 6px;
    }

    ul {
        margin-top: 4px;
        padding-left: 20px;
        font-size: 14px;
    }

    .preview-item {
        background: #f7f7f7;
        padding: 6px;
        margin: 5px 0;
        border-radius: 4px;
        font-size: 13px;
    }

    .boton-principal {
        width: 100%;
        padding: 12px;
        background: #0078d4;
        color: white;
        border: none;
        margin-top: 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }

    .boton-principal:hover {
        background: #005fa3;
    }

    canvas {
        width: 100% !important;
        height: 180px !important;
        margin-bottom: 20px;
        background: white;
        border-radius: 6px;
    }
</style>
</head>

<body>

<div id="sidebar">

    <h2>Instrucciones para el Formulario</h2>

    <p>Antes de enviar tu reporte, sigue estos pasos:</p>

    <ul>
        <li><strong>Mueve el marcador</strong> al lugar exacto de tu predio o √°rea de riego.</li>
        <br>
        <li>Revisa la <strong>vista previa del formulario</strong> para saber qu√© informaci√≥n se pedir√°.</li>
        <br>
        <li>Cuando est√©s listo, presiona el bot√≥n para abrir el <strong>FORMULARIO oficial.</strong></li>
    </ul>

    <p style="font: size 15px; color:black ">
    Importante: Al finalizar el formulario en KoboToolbox <strong>debes presionar la opci√≥n SUBMIT</strong>.  
    ‚ÄúSave Draft‚Äù NO env√≠a el reporte.
    </p>

    <h2>Vista previa del Formulario</h2>
 
    <div class="preview-item">‚Ä¢ Origen del agua</div>
    <div class="preview-item">‚Ä¢ Tipo de conducci√≥n</div>
    <div class="preview-item">‚Ä¢ Nombre del canal / r√≠o / pozo</div>
    <div class="preview-item">‚Ä¢ Superficie del predio (ha)</div>
    <div class="preview-item">‚Ä¢ Cultivo principal</div>
    <div class="preview-item">‚Ä¢ Grado de afectaci√≥n</div>
    <div class="preview-item">‚Ä¢ Observaciones</div>
    <div class="preview-item">‚Ä¢ Foto (opcional)</div>
    <div class="preview-item">‚Ä¢ Ubicaci√≥n GPS</div>

    <button class="boton-principal" onclick="enviarKobo()">
        ABRIR FORMULARIO OFICIAL
    </button>

    <!-- üìä NUEVOS GR√ÅFICOS -->
    <h3>Distribuci√≥n del grado de afectaci√≥n</h3>
    <canvas id="afectacionChart"></canvas>

    <h3>Distribuci√≥n del origen del agua</h3>
    <canvas id="origenChart"></canvas>

    <h3>Distribuci√≥n de superficies de predios (ha)</h3>
    <canvas id="superficieChart"></canvas>

</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Inicializar mapa
var map = L.map('map').setView([-33.45, -70.66], 13);

// Capa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
}).addTo(map);

// Marcador del usuario
var userMarker;

// Ubicaci√≥n del usuario
map.locate({ setView: true, maxZoom: 16 });

map.on('locationfound', function(e) {
    if (userMarker) map.removeLayer(userMarker);

    userMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
    userMarker.bindPopup("Mueve este marcador para ubicar tu campo").openPopup();
});

map.on('locationerror', function() {
    alert("No se pudo obtener tu ubicaci√≥n. Mueve el marcador manualmente.");

    userMarker = L.marker([-33.45, -70.66], { draggable: true }).addTo(map);
    userMarker.bindPopup("Mueve este marcador para ubicar tu campo").openPopup();
});

// KoboToolbox
function enviarKobo() {
    var koboURL = "https://ee.kobotoolbox.org/x/QmnUgP90";
    alert("Ser√°s redirigido al formulario oficial para completar tu reporte.");
    window.open(koboURL, "_blank");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// === Colores seg√∫n grado de afectaci√≥n ===
const coloresAfectacion = {
    "leve": "#4CAF50",
    "media": "#FFC107",
    "severa": "#FF5722",
    "p√©rdida total": "#9C27B0",
    "perdida total": "#9C27B0"
};

// === Lectura de CSV ===
function cargarCSV() {
    Papa.parse("data/prueba_3.csv", {
        download: true,
        header: true,

        complete: function(results) {
            let datos = results.data;

            // Estad√≠sticas
            let afectCount = {};
            let origenCount = {};
            let superficiesLista = [];

            datos.forEach(function(row) {

                if (!row["_Ubicaci√≥n GPS del punto reportado_latitude"] ||
                    !row["_Ubicaci√≥n GPS del punto reportado_longitude"]) return;

                let lat = parseFloat(row["_Ubicaci√≥n GPS del punto reportado_latitude"]);
                let lng = parseFloat(row["_Ubicaci√≥n GPS del punto reportado_longitude"]);
                let grado = row["Grado de afectaci√≥n"]?.toLowerCase();
                let origen = row["Origen del agua"];
                let sup = parseFloat(row["Superficie del predio (ha)"]);

                // Contadores
                afectCount[grado] = (afectCount[grado] || 0) + 1;
                origenCount[origen] = (origenCount[origen] || 0) + 1;

                if (!isNaN(sup)) superficiesLista.push(sup);

                // Marcador
                L.circleMarker([lat, lng], {
                    radius: 8,
                    color: coloresAfectacion[grado] || "gray",
                    fillColor: coloresAfectacion[grado] || "gray",
                    fillOpacity: 0.9,
                    weight: 2
                })
                .addTo(map)
                .bindPopup(`
                    <b>Origen del agua:</b> ${origen}<br>
                    <b>Superficie:</b> ${sup} ha<br>
                    <b>Afectaci√≥n:</b> ${row["Grado de afectaci√≥n"]}<br>
                    <b>Fecha:</b> ${row["_submission_time"]}<br>
                `);
            });

            // === Gr√°fico A ===
            new Chart(document.getElementById("afectacionChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(afectCount),
                    datasets: [{
                        label: "Cantidad",
                        data: Object.values(afectCount),
                        backgroundColor: Object.keys(afectCount).map(g => coloresAfectacion[g] || "gray")
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            // === Gr√°fico B ===
            new Chart(document.getElementById("origenChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(origenCount),
                    datasets: [{
                        label: "Cantidad",
                        data: Object.values(origenCount),
                        backgroundColor: "steelblue"
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            // === GR√ÅFICO C (nuevo): Histograma de superficies ===

            // Creamos bins simples de tama√±o 5 ha
            let bins = {};
            superficiesLista.forEach(v => {
                let bin = Math.floor(v / 5) * 5;
                let label = `${bin} - ${bin+5}`;
                bins[label] = (bins[label] || 0) + 1;
            });

            new Chart(document.getElementById("superficieChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(bins),
                    datasets: [{
                        label: "Cantidad de predios",
                        data: Object.values(bins),
                        backgroundColor: "orange"
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { title: { display: true, text: "Rango de superficie (ha)" } } }
                }
            });

        }
    });
}

// Ejecutar
cargarCSV();
</script>

</body>
</html>



